<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player - Multiplayer Retro Gaming</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .status-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .join-screen {
            padding: 60px 40px;
            text-align: center;
        }

        .join-screen h2 {
            font-size: 32px;
            color: #333;
            margin-bottom: 16px;
        }

        .join-screen p {
            color: #666;
            margin-bottom: 40px;
        }

        .input-group {
            max-width: 400px;
            margin: 0 auto 20px;
        }

        .input-group label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .game-screen {
            display: none;
            padding: 20px;
        }

        .game-screen.active {
            display: block;
        }

        .game-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #game-canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        .controls-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .gamepad-status {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .gamepad-connected {
            color: #10b981;
            font-weight: 600;
        }

        .gamepad-disconnected {
            color: #ef4444;
            font-weight: 600;
        }

        .log {
            max-height: 150px;
            overflow-y: auto;
            font-size: 11px;
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #ef4444;
            color: #dc2626;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Player - Multiplayer Gaming</h1>
            <div class="status-badge">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Desconectado</span>
            </div>
        </div>

        <!-- Tela de Join -->
        <div class="join-screen" id="join-screen">
            <h2>Entrar na Sala</h2>
            <p>Digite o c√≥digo da sala fornecido pelo host</p>
            
            <div class="input-group">
                <label for="room-code-input">C√≥digo da Sala</label>
                <input 
                    type="text" 
                    id="room-code-input" 
                    placeholder="Ex: ROOM-ABC123"
                    maxlength="15"
                >
            </div>

            <div class="input-group">
                <label for="player-name-input">Seu Nome</label>
                <input 
                    type="text" 
                    id="player-name-input" 
                    placeholder="Digite seu nome"
                    value="Player"
                    maxlength="20"
                >
            </div>

            <button class="btn" id="join-btn" onclick="joinRoom()">
                üöÄ Entrar na Sala
            </button>

            <div id="error-container"></div>
        </div>

        <!-- Tela do Jogo -->
        <div class="game-screen" id="game-screen">
            <div class="game-container">
                <canvas id="game-canvas"></canvas>
            </div>

            <div class="controls-panel">
                <div class="card">
                    <h3>üìä Estat√≠sticas</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="fps">0</div>
                            <div class="stat-label">FPS</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="latency">-</div>
                            <div class="stat-label">Lat√™ncia</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="frames-received">0</div>
                            <div class="stat-label">Frames</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="inputs-sent">0</div>
                            <div class="stat-label">Inputs</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üéÆ Gamepad</h3>
                    <div class="gamepad-status" id="gamepad-status">
                        <div class="gamepad-disconnected">
                            ‚ùå Nenhum controle conectado
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 11px; color: #666;">
                        Conecte um controle USB ou Bluetooth
                    </div>
                </div>

                <div class="card">
                    <h3>üìù Log</h3>
                    <div class="log" id="log"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.io e SimplePeer -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>

    <script>
        // Configura√ß√£o
        const SIGNALING_SERVER = 'https://seu-servidor.com'; // MUDAR PARA SEU SERVIDOR
        const socket = io(SIGNALING_SERVER);
        
        // Estado
        let hostPeer = null;
        let roomId = '';
        let playerNumber = 0;
        let framesReceived = 0;
        let inputsSent = 0;
        let gamepadIndex = null;
        let lastFrameTime = Date.now();
        let fpsCounter = 0;
        let lastFpsUpdate = Date.now();

        // Auto-preencher room code da URL
        const params = new URLSearchParams(window.location.search);
        if (params.get('room')) {
            document.getElementById('room-code-input').value = params.get('room');
        }

        // Log helper
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            
            if (logDiv) {
                logDiv.insertBefore(entry, logDiv.firstChild);
                
                // Manter apenas √∫ltimas 50 entradas
                while (logDiv.children.length > 50) {
                    logDiv.removeChild(logDiv.lastChild);
                }
            }
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function updateStatus(text, connected = false) {
            document.getElementById('status-text').textContent = text;
            const dot = document.getElementById('status-dot');
            dot.style.background = connected ? '#10b981' : '#ef4444';
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `
                <div class="error-message">
                    ‚ùå ${message}
                </div>
            `;
        }

        function joinRoom() {
            roomId = document.getElementById('room-code-input').value.trim().toUpperCase();
            const playerName = document.getElementById('player-name-input').value.trim();
            
            if (!roomId) {
                showError('Digite o c√≥digo da sala');
                return;
            }
            
            if (!playerName) {
                showError('Digite seu nome');
                return;
            }
            
            log('üîå Conectando √† sala: ' + roomId);
            updateStatus('Conectando...', false);
            
            const userId = playerName + '-' + Date.now();
            socket.emit('join-room', { roomId, userId });
        }

        // Eventos do Socket
        socket.on('room-joined', ({ roomId: id, hostPeerId, playerNumber: pNum }) => {
            log('‚úÖ Entrou na sala: ' + id);
            playerNumber = pNum;
            updateStatus('Conectado - Player ' + playerNumber, true);
            
            // Criar conex√£o P2P com host
            createPeerConnection(hostPeerId);
            
            // Mostrar tela do jogo
            document.getElementById('join-screen').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
        });

        socket.on('room-full', () => {
            showError('Sala cheia! M√°ximo de 4 jogadores.');
            log('‚ùå Sala cheia');
        });

        socket.on('host-disconnected', () => {
            showError('Host desconectou. Sess√£o encerrada.');
            log('‚ùå Host desconectou');
            updateStatus('Desconectado', false);
            
            if (hostPeer) {
                hostPeer.destroy();
            }
        });

        socket.on('webrtc-signal', ({ from, signal }) => {
            if (hostPeer) {
                hostPeer.signal(signal);
            }
        });

        function createPeerConnection(hostPeerId) {
            log('üîó Criando conex√£o P2P...');
            
            hostPeer = new SimplePeer({
                initiator: false,
                trickle: false,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            hostPeer.on('signal', (signal) => {
                socket.emit('webrtc-signal', {
                    to: hostPeerId,
                    signal
                });
            });

            hostPeer.on('connect', () => {
                log('‚úÖ Conex√£o P2P estabelecida');
                updateStatus('Conectado - Player ' + playerNumber, true);
                setupGamepad();
            });

            hostPeer.on('data', (data) => {
                try {
                    const message = JSON.parse(data.toString());
                    
                    if (message.type === 'video-frame') {
                        displayFrame(message.data);
                        updateLatency(message.timestamp);
                    }
                } catch (e) {
                    console.warn('Erro ao processar dados:', e);
                }
            });

            hostPeer.on('error', (err) => {
                log('‚ùå Erro P2P: ' + err.message, 'error');
            });

            hostPeer.on('close', () => {
                log('üîå Conex√£o P2P fechada');
                updateStatus('Desconectado', false);
            });
        }

        function displayFrame(frameData) {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                framesReceived++;
                fpsCounter++;
                
                // Atualizar FPS a cada segundo
                const now = Date.now();
                if (now - lastFpsUpdate >= 1000) {
                    document.getElementById('fps').textContent = fpsCounter;
                    fpsCounter = 0;
                    lastFpsUpdate = now;
                }
                
                document.getElementById('frames-received').textContent = framesReceived;
            };
            img.src = frameData;
        }

        function updateLatency(timestamp) {
            const latency = Date.now() - timestamp;
            document.getElementById('latency').textContent = latency + 'ms';
        }

        function setupGamepad() {
            log('üéÆ Configurando gamepad...');
            
            // Detectar gamepad conectado
            window.addEventListener('gamepadconnected', (e) => {
                gamepadIndex = e.gamepad.index;
                log('‚úÖ Gamepad conectado: ' + e.gamepad.id);
                
                const statusDiv = document.getElementById('gamepad-status');
                statusDiv.innerHTML = `
                    <div class="gamepad-connected">
                        ‚úÖ ${e.gamepad.id}
                    </div>
                `;
                
                startGamepadPolling();
            });
            
            window.addEventListener('gamepaddisconnected', (e) => {
                log('‚ùå Gamepad desconectado');
                gamepadIndex = null;
                
                const statusDiv = document.getElementById('gamepad-status');
                statusDiv.innerHTML = `
                    <div class="gamepad-disconnected">
                        ‚ùå Nenhum controle conectado
                    </div>
                `;
            });
            
            // Verificar se j√° tem gamepad conectado
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    gamepadIndex = i;
                    log('‚úÖ Gamepad detectado: ' + gamepads[i].id);
                    
                    const statusDiv = document.getElementById('gamepad-status');
                    statusDiv.innerHTML = `
                        <div class="gamepad-connected">
                            ‚úÖ ${gamepads[i].id}
                        </div>
                    `;
                    
                    startGamepadPolling();
                    break;
                }
            }
        }

        let lastButtonStates = {};

        function startGamepadPolling() {
            function poll() {
                if (gamepadIndex !== null && hostPeer && hostPeer.connected) {
                    const gamepads = navigator.getGamepads();
                    const gamepad = gamepads[gamepadIndex];
                    
                    if (gamepad) {
                        // Verificar bot√µes
                        gamepad.buttons.forEach((button, index) => {
                            const key = 'btn-' + index;
                            const wasPressed = lastButtonStates[key] || false;
                            const isPressed = button.pressed;
                            
                            if (isPressed !== wasPressed) {
                                sendInput({
                                    type: 'button',
                                    button: index,
                                    pressed: isPressed,
                                    player: playerNumber
                                });
                                
                                lastButtonStates[key] = isPressed;
                            }
                        });
                        
                        // Enviar axes (anal√≥gicos) se houver mudan√ßa significativa
                        if (Math.abs(gamepad.axes[0]) > 0.1 || 
                            Math.abs(gamepad.axes[1]) > 0.1) {
                            sendInput({
                                type: 'axes',
                                axes: [
                                    gamepad.axes[0],
                                    gamepad.axes[1],
                                    gamepad.axes[2] || 0,
                                    gamepad.axes[3] || 0
                                ],
                                player: playerNumber
                            });
                        }
                    }
                }
                
                requestAnimationFrame(poll);
            }
            
            poll();
        }

        function sendInput(input) {
            if (hostPeer && hostPeer.connected) {
                try {
                    hostPeer.send(JSON.stringify({
                        ...input,
                        timestamp: Date.now()
                    }));
                    
                    inputsSent++;
                    document.getElementById('inputs-sent').textContent = inputsSent;
                } catch (e) {
                    console.warn('Erro ao enviar input:', e);
                }
            }
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (hostPeer) {
                hostPeer.destroy();
            }
            socket.disconnect();
        });
    </script>
</body>
</html>
