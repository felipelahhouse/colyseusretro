<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ•Ô∏è HOST - EmulatorJS Multiplayer (PeerJS)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.emulatorjs.org/stable/data/loader.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .panel {
            background: rgba(0,0,0,0.5);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            margin-bottom: 15px;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
            padding: 15px;
            border-radius: 10px;
        }

        .status-card.warning {
            background: rgba(255, 152, 0, 0.3);
            border-color: #FF9800;
        }

        .status-card h3 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .status-card .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .player-card.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .player-number {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        #game {
            width: 100%;
            height: 600px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .code-display {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 3px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            border: 3px dashed #4CAF50;
        }

        .info-box {
            background: rgba(33, 150, 243, 0.3);
            border: 2px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .controls-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .control-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .log-container {
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è HOST - Multiplayer Room</h1>
        <p class="subtitle">Compartilhe seu jogo via WebRTC P2P</p>

        <!-- STATUS DA SALA -->
        <div class="panel">
            <h2>üìä Status da Sala</h2>
            
            <div class="status-grid">
                <div class="status-card">
                    <h3>üè† Sala</h3>
                    <div class="value" id="room-name">-</div>
                </div>
                <div class="status-card">
                    <h3>üë• Jogadores</h3>
                    <div class="value" id="players-count">0/4</div>
                </div>
                <div class="status-card">
                    <h3>üéÆ Jogo</h3>
                    <div class="value" id="game-name">-</div>
                </div>
                <div class="status-card warning">
                    <h3>üì° Status</h3>
                    <div class="value" id="streaming-status">Aguardando</div>
                </div>
            </div>

            <div class="code-display">
                üÜî ID DA SALA: <span id="room-code">-</span>
            </div>

            <div class="info-box">
                <strong>üí° Instru√ß√µes:</strong><br>
                1. Configure o emulador abaixo<br>
                2. Compartilhe o ID da sala com os jogadores<br>
                3. Inicie o streaming quando todos estiverem prontos
            </div>
        </div>

        <!-- CONFIGURA√á√ÉO DO EMULADOR -->
        <div class="panel" id="setup-panel">
            <h2>‚öôÔ∏è Configurar Emulador</h2>

            <div class="form-group">
                <label>Console:</label>
                <select id="console-select">
                    <option value="snes">Super Nintendo (SNES)</option>
                    <option value="nes">Nintendo (NES)</option>
                    <option value="gba">Game Boy Advance</option>
                    <option value="gb">Game Boy / GBC</option>
                    <option value="segaMD">Sega Genesis</option>
                    <option value="n64">Nintendo 64</option>
                    <option value="psx">PlayStation 1</option>
                    <option value="atari2600">Atari 2600</option>
                </select>
            </div>

            <div class="form-group">
                <label>ROM (URL ou Arquivo):</label>
                <input type="text" id="rom-url" placeholder="https://example.com/game.smc">
                <input type="file" id="rom-file" accept=".smc,.sfc,.nes,.gba,.gb,.gbc,.md,.gen,.z64,.n64,.iso,.bin,.a26" style="margin-top:10px;">
            </div>

            <button onclick="iniciarEmulador()">üéÆ Carregar Emulador</button>
        </div>

        <!-- JOGADORES CONECTADOS -->
        <div class="panel">
            <h2>üë• Jogadores Conectados</h2>
            <div class="players-list" id="players-list">
                <div class="player-card">
                    <div class="player-number">1</div>
                    <div>Aguardando...</div>
                </div>
                <div class="player-card">
                    <div class="player-number">2</div>
                    <div>Aguardando...</div>
                </div>
                <div class="player-card">
                    <div class="player-number">3</div>
                    <div>Aguardando...</div>
                </div>
                <div class="player-card">
                    <div class="player-number">4</div>
                    <div>Aguardando...</div>
                </div>
            </div>

            <div class="controls-map">
                <div class="control-item">
                    <strong>üéÆ P1 (Voc√™):</strong> Setas + Z/X
                </div>
                <div class="control-item">
                    <strong>üéÆ P2:</strong> WASD + T/Y
                </div>
                <div class="control-item">
                    <strong>üéÆ P3:</strong> IJKL + N/M
                </div>
                <div class="control-item">
                    <strong>üéÆ P4:</strong> Numpad
                </div>
            </div>

            <button onclick="iniciarStreaming()" id="btn-streaming" disabled>
                üì∫ Iniciar Streaming
            </button>
            <button onclick="fecharSala()" class="danger">
                ‚ùå Fechar Sala
            </button>
        </div>

        <!-- EMULADOR -->
        <div class="panel">
            <h2>üéÆ Emulador</h2>
            <div id="game"></div>
        </div>

        <!-- LOGS -->
        <div class="panel">
            <h2>üìã Logs do Sistema</h2>
            <div class="log-container" id="logs"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO
        // ==========================================
        const SERVIDOR_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:9000'
            : window.location.origin;

        const PEER_CONFIG = {
            host: window.location.hostname === 'localhost' ? 'localhost' : window.location.hostname,
            port: window.location.hostname === 'localhost' ? 9000 : window.location.port || 443,
            path: '/peerjs',
            secure: window.location.protocol === 'https:',
            debug: 2
        };

        let peer = null;
        let roomData = null;
        let emulador = null;
        let mediaStream = null;
        let connectedPlayers = new Map(); // peerId -> { conn, call, playerIndex }

        // Mapeamento de teclas por jogador
        const PLAYER_KEYS = {
            1: { up: 'ArrowUp', down: 'ArrowDown', left: 'ArrowLeft', right: 'ArrowRight', a: 'z', b: 'x', start: 'Enter', select: 'Shift' },
            2: { up: 'w', down: 's', left: 'a', right: 'd', a: 't', b: 'y', start: 'g', select: 'h' },
            3: { up: 'i', down: 'k', left: 'j', right: 'l', a: 'n', b: 'm', start: 'b', select: 'v' },
            4: { up: 'Numpad8', down: 'Numpad5', left: 'Numpad4', right: 'Numpad6', a: 'Numpad1', b: 'Numpad2', start: 'Numpad0', select: 'NumpadDecimal' }
        };

        // ==========================================
        // LOGS
        // ==========================================
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            
            logs.insertBefore(logEntry, logs.firstChild);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        // ==========================================
        // INICIALIZA√á√ÉO
        // ==========================================
        window.addEventListener('DOMContentLoaded', async () => {
            // Recuperar dados da sala
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');

            if (!roomId) {
                alert('‚ùå ID da sala n√£o encontrado!');
                window.location.href = 'lobby.html';
                return;
            }

            const storedData = localStorage.getItem('currentRoom');
            if (!storedData) {
                alert('‚ùå Dados da sala n√£o encontrados!');
                window.location.href = 'lobby.html';
                return;
            }

            roomData = JSON.parse(storedData);
            
            if (roomData.roomId !== roomId || !roomData.isHost) {
                alert('‚ùå Voc√™ n√£o √© o host desta sala!');
                window.location.href = 'lobby.html';
                return;
            }

            // Atualizar interface
            document.getElementById('room-name').textContent = roomData.name;
            document.getElementById('game-name').textContent = roomData.game;
            document.getElementById('room-code').textContent = roomData.roomId;

            addLog(`Sala criada: ${roomData.name}`, 'success');
            addLog(`Aguardando conex√£o com PeerJS...`);

            // Inicializar PeerJS com ID espec√≠fico
            inicializarPeer();
        });

        // ==========================================
        // PEERJS
        // ==========================================
        function inicializarPeer() {
            peer = new Peer(roomData.hostPeerId, PEER_CONFIG);

            peer.on('open', (id) => {
                addLog(`Conectado ao PeerJS. ID: ${id}`, 'success');
                document.getElementById('streaming-status').textContent = 'Pronto';
                
                // Aguardar conex√µes de players
                setupPeerListeners();
            });

            peer.on('error', (err) => {
                addLog(`Erro PeerJS: ${err.message || err.type}`, 'error');
            });
        }

        function setupPeerListeners() {
            // Receber conex√µes de dados (chat/comandos)
            peer.on('connection', (conn) => {
                const playerPeerId = conn.peer;
                addLog(`Player conectando: ${playerPeerId.substring(0, 10)}...`);

                conn.on('open', () => {
                    addLog(`Player conectado: ${playerPeerId.substring(0, 10)}...`, 'success');
                    
                    // Enviar confirma√ß√£o
                    conn.send({
                        type: 'welcome',
                        message: 'Bem-vindo √† sala!',
                        roomInfo: roomData
                    });

                    // Armazenar conex√£o
                    if (!connectedPlayers.has(playerPeerId)) {
                        connectedPlayers.set(playerPeerId, { conn, playerIndex: connectedPlayers.size + 1 });
                    }

                    atualizarListaPlayers();
                });

                conn.on('data', (data) => {
                    handlePlayerData(playerPeerId, data);
                });

                conn.on('close', () => {
                    addLog(`Player desconectado: ${playerPeerId.substring(0, 10)}...`, 'warning');
                    connectedPlayers.delete(playerPeerId);
                    atualizarListaPlayers();
                });
            });

            // Receber chamadas de v√≠deo
            peer.on('call', (call) => {
                addLog(`Chamada de v√≠deo recebida de: ${call.peer.substring(0, 10)}...`);
                
                if (mediaStream) {
                    call.answer(mediaStream);
                    addLog(`Respondendo chamada com stream`, 'success');

                    const player = connectedPlayers.get(call.peer);
                    if (player) {
                        player.call = call;
                    }
                } else {
                    addLog(`Stream ainda n√£o dispon√≠vel`, 'warning');
                }
            });
        }

        function handlePlayerData(playerId, data) {
            if (data.type === 'input') {
                // Simular tecla pressionada pelo player
                const player = connectedPlayers.get(playerId);
                if (!player || !emulador) return;

                const playerKeys = PLAYER_KEYS[player.playerIndex];
                if (!playerKeys) return;

                const key = playerKeys[data.button];
                if (!key) return;

                // Simular evento de teclado
                const event = new KeyboardEvent(data.action, {
                    key: key,
                    code: key,
                    bubbles: true
                });

                const gameDiv = document.querySelector('#game');
                if (gameDiv) {
                    gameDiv.dispatchEvent(event);
                    addLog(`P${player.playerIndex} pressionou ${data.button}`);
                }
            }
        }

        function atualizarListaPlayers() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            for (let i = 1; i <= 4; i++) {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';

                // Verificar se tem algum player com este √≠ndice
                const player = Array.from(connectedPlayers.values()).find(p => p.playerIndex === i);

                if (player) {
                    playerCard.classList.add('active');
                    const peerId = Array.from(connectedPlayers.entries()).find(([k, v]) => v === player)?.[0];
                    playerCard.innerHTML = `
                        <div class="player-number">${i}</div>
                        <div>üü¢ Conectado</div>
                        <div style="font-size:0.8em; opacity:0.7;">${peerId.substring(0, 8)}...</div>
                    `;
                } else {
                    playerCard.innerHTML = `
                        <div class="player-number">${i}</div>
                        <div>‚ö™ Aguardando...</div>
                    `;
                }

                playersList.appendChild(playerCard);
            }

            document.getElementById('players-count').textContent = `${connectedPlayers.size}/4`;

            // Habilitar streaming se tiver pelo menos 1 player e emulador carregado
            if (connectedPlayers.size > 0 && emulador) {
                document.getElementById('btn-streaming').disabled = false;
            }
        }

        // ==========================================
        // EMULADOR
        // ==========================================
        function iniciarEmulador() {
            const console = document.getElementById('console-select').value;
            const romUrl = document.getElementById('rom-url').value.trim();
            const romFile = document.getElementById('rom-file').files[0];

            if (!romUrl && !romFile) {
                alert('‚ùå Selecione uma ROM!');
                return;
            }

            addLog(`Carregando emulador: ${console}...`);

            EJS_player = '#game';
            EJS_core = console;
            EJS_gameUrl = romFile ? URL.createObjectURL(romFile) : romUrl;
            EJS_pathtodata = 'https://cdn.emulatorjs.org/stable/data/';

            try {
                // Remover emulador anterior se existir
                document.getElementById('game').innerHTML = '';
                
                // Carregar novo emulador
                const script = document.createElement('script');
                script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
                document.body.appendChild(script);

                setTimeout(() => {
                    emulador = window.EJS_emulator;
                    addLog('Emulador carregado!', 'success');
                    document.getElementById('setup-panel').style.display = 'none';
                    
                    // Preparar stream ap√≥s carregar
                    setTimeout(() => {
                        prepararStream();
                    }, 2000);
                }, 3000);
            } catch (error) {
                addLog(`Erro ao carregar emulador: ${error.message}`, 'error');
            }
        }

        function prepararStream() {
            try {
                const canvas = document.querySelector('#game canvas');
                if (!canvas) {
                    addLog('Canvas do emulador n√£o encontrado', 'warning');
                    setTimeout(prepararStream, 1000);
                    return;
                }

                mediaStream = canvas.captureStream(30); // 30 FPS
                addLog('Stream de v√≠deo capturado!', 'success');
                
                if (connectedPlayers.size > 0) {
                    document.getElementById('btn-streaming').disabled = false;
                }
            } catch (error) {
                addLog(`Erro ao capturar stream: ${error.message}`, 'error');
            }
        }

        function iniciarStreaming() {
            if (!mediaStream) {
                alert('‚ùå Stream n√£o est√° dispon√≠vel ainda!');
                return;
            }

            addLog('Iniciando streaming para todos os players...', 'success');
            document.getElementById('streaming-status').textContent = 'Streaming';

            // Notificar todos os players que o streaming come√ßou
            connectedPlayers.forEach((player, peerId) => {
                if (player.conn) {
                    player.conn.send({
                        type: 'stream-started',
                        message: 'O host iniciou o streaming!'
                    });
                }
            });

            document.getElementById('btn-streaming').disabled = true;
            document.getElementById('btn-streaming').textContent = '‚úÖ Streaming Ativo';
        }

        async function fecharSala() {
            if (!confirm('‚ùå Tem certeza que deseja fechar a sala? Todos os jogadores ser√£o desconectados.')) {
                return;
            }

            try {
                // Notificar players
                connectedPlayers.forEach((player) => {
                    if (player.conn) {
                        player.conn.send({ type: 'room-closed', message: 'O host fechou a sala.' });
                        player.conn.close();
                    }
                    if (player.call) {
                        player.call.close();
                    }
                });

                // Deletar sala no servidor
                await fetch(`${SERVIDOR_URL}/api/salas/${roomData.roomId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hostPeerId: roomData.hostPeerId })
                });

                // Desconectar peer
                if (peer) {
                    peer.destroy();
                }

                localStorage.removeItem('currentRoom');
                window.location.href = 'lobby.html';
            } catch (error) {
                addLog(`Erro ao fechar sala: ${error.message}`, 'error');
            }
        }

        // Limpar ao sair
        window.addEventListener('beforeunload', () => {
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html>
