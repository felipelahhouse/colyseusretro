<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    
    <!-- 🚀 Performance & SEO -->
    <meta name="theme-color" content="#06b6d4" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- Preconnect para recursos externos -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    
    <!-- 🔥 PREVINE CACHE - Força navegador a sempre pegar versão nova -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>PlayNow Emulator - Retro Gaming Platform</title>
    <meta name="description" content="Play classic retro games online with multiplayer support, live streaming, and more!" />
    
    <!-- 🚫 BLOQUEIA SERVICE WORKER E SUPRIME ERROS - Executa ANTES de tudo -->
    <script>
      (function() {
        // ========================================
        // 🛡️ SUPRESSÃO GLOBAL DE ERROS (PRIMEIRO!)
        // ========================================
        
        // Suprime erros globais de window
        window.addEventListener('error', function(e) {
          const msg = e.message || '';
          if (
            msg.includes('ServiceWorker') ||
            msg.includes('service worker') ||
            msg.includes('service-worker') ||
            msg.includes('Service Worker') ||
            msg.includes('desabilitado') ||
            msg.includes('disabled') ||
            msg.includes('blocked') ||
            msg.includes('bloqueada') ||
            msg.includes('sw.js') ||
            msg.includes('InvalidStateError') ||
            msg.includes('Failed to update a ServiceWorker') ||
            msg.includes('Failed to register a ServiceWorker') ||
            msg.includes('permission-denied') ||
            msg.includes('Missing or insufficient permissions') ||
            msg.includes('Firestore') ||
            msg.includes('@firebase') ||
            msg.includes('WebStorage notification') ||
            msg.includes('garbage-collected') ||
            msg.includes('Not found') ||
            msg.includes('Unknown')
          ) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
          }
        }, true);
        
        // Suprime console.error para Firestore e outros warnings
        const originalConsoleError = console.error;
        console.error = function(...args) {
          const message = args.join(' ');
          const stack = new Error().stack || '';
          
          // Suprime erros do Firestore WebChannel e BloomFilter
          if (
            message.includes('Firestore') ||
            message.includes('@firebase') ||
            message.includes('permission-denied') ||
            message.includes('Missing or insufficient permissions') ||
            message.includes('WebStorage notification') ||
            message.includes('garbage-collected') ||
            message.includes('BloomFilter') ||
            message.includes('Bad Request') ||
            message.includes('400') ||
            message.includes('firestore.googleapis.com') ||
            stack.includes('webchannel_blob_es2018.js') ||
            stack.includes('gameStorage.ts')
          ) {
            return; // Não exibe
          }
          originalConsoleError.apply(console, args);
        };
        
        // Suprime console.log para logs verbosos do Firestore
        const originalConsoleLog = console.log;
        console.log = function(...args) {
          const message = args.join(' ');
          if (
            message.includes('BloomFilter error') ||
            message.includes('@firebase/firestore')
          ) {
            return; // Não exibe
          }
          originalConsoleLog.apply(console, args);
        };
        
        // Suprime console.warn para warnings do Firestore
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
          const message = args.join(' ');
          if (
            message.includes('Firestore') ||
            message.includes('@firebase') ||
            message.includes('BloomFilter')
          ) {
            return; // Não exibe
          }
          originalConsoleWarn.apply(console, args);
        };
        
        // Intercepta XMLHttpRequest para suprimir logs de erro do Firestore
        const originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...args) {
          this._url = url;
          return originalXHROpen.call(this, method, url, ...args);
        };
        
        const originalXHRSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function(...args) {
          const url = this._url || '';
          if (url.includes('firestore.googleapis.com')) {
            // Suprime logs de erro para requisições do Firestore
            const originalOnError = this.onerror;
            this.onerror = function(e) {
              // Não loga erros do Firestore
              if (originalOnError) originalOnError.call(this, e);
            };
            
            const originalOnLoadEnd = this.onloadend;
            this.onloadend = function(e) {
              // Não loga status 400 do Firestore
              if (originalOnLoadEnd) originalOnLoadEnd.call(this, e);
            };
          }
          return originalXHRSend.call(this, ...args);
        };
        
        // Intercepta fetch para suprimir erros do Firestore
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          const url = typeof args[0] === 'string' ? args[0] : args[0]?.url || '';
          
          if (url.includes('firestore.googleapis.com')) {
            return originalFetch.apply(this, args).catch(err => {
              // Suprime erro 400 do Firestore silenciosamente
              if (err.message?.includes('400') || err.message?.includes('Bad Request')) {
                return Promise.resolve(new Response('{}', { status: 200 }));
              }
              throw err;
            });
          }
          
          return originalFetch.apply(this, args);
        };
        
        // Suprime promises rejeitadas
        window.addEventListener('unhandledrejection', function(e) {
          const msg = String(e.reason || '');
          if (
            msg.includes('ServiceWorker') ||
            msg.includes('service worker') ||
            msg.includes('service-worker') ||
            msg.includes('Service Worker') ||
            msg.includes('desabilitado') ||
            msg.includes('disabled') ||
            msg.includes('blocked') ||
            msg.includes('bloqueada') ||
            msg.includes('sw.js') ||
            msg.includes('InvalidStateError') ||
            msg.includes('Failed to update a ServiceWorker') ||
            msg.includes('Failed to register a ServiceWorker') ||
            msg.includes('Firestore') ||
            msg.includes('BloomFilter') ||
            msg.includes('Bad Request') ||
            msg.includes('400') ||
            msg.includes('Not found') ||
            msg.includes('Unknown')
          ) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        }, true);
        
        // Suprime console.error
        const originalError = console.error;
        console.error = function(...args) {
          const message = args[0]?.toString() || '';
          if (
            message.includes('ServiceWorker') ||
            message.includes('service worker') ||
            message.includes('service-worker') ||
            message.includes('Service Worker') ||
            message.includes('desabilitado') ||
            message.includes('disabled') ||
            message.includes('blocked') ||
            message.includes('bloqueada') ||
            message.includes('sw.js') ||
            message.includes('InvalidStateError') ||
            message.includes('Failed to update a ServiceWorker') ||
            message.includes('Failed to register a ServiceWorker') ||
            message.includes('Missing or insufficient permissions') ||
            message.includes('FirebaseError') ||
            message.includes('Not found') ||
            message.includes('Unknown')
          ) {
            return; // Não exibe o erro
          }
          originalError.apply(console, args);
        };
        
        // ========================================
        // 🚫 BLOQUEIA SERVICE WORKER
        // ========================================
        
        if ('serviceWorker' in navigator) {
          // Bloqueia registro de ServiceWorker imediatamente
          navigator.serviceWorker.register = function() {
            return Promise.reject(new Error('Service Worker desabilitado'));
          };
          
          // Desregistrar ServiceWorkers existentes (silenciosamente)
          navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
              registration.unregister().catch(() => {});
            });
          }).catch(() => {});
        }
      })();
    </script>
    
    <!-- 🔄 AUTO-RELOAD: Detecta novas versões e atualiza automaticamente -->
    <script src="/auto-reload.js"></script>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- 🎮 PeerJS para Multiplayer P2P -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
